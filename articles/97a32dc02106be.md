---
title: "Next.js v13ã®Middlewareã‚’ä½¿ã£ã¦vercelã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒã‚’æ§‹ç¯‰ã—ã‚ˆã†"
emoji: "ğŸ¤–"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["nextjs", "vercel", "typescript"]
published: true
---

## ã“ã®è¨˜äº‹ã«ã¤ã„ã¦

ã“ã®è¨˜äº‹ã§ã¯ã€Next.js v12 ã‹ã‚‰å°å…¥ã•ã‚ŒãŸ [Middleware](https://nextjs.org/docs/advanced-features/middleware) ã‚’ä½¿ã£ã¦ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§æ±‚ã‚ã‚‰ã‚Œã‚‹ã“ã¨ãŒå¤šã„ä»¥ä¸‹ã®è¦ä»¶ã‚’æº€ãŸã™ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒã‚’æ§‹ç¯‰ã—ã¾ã™ ğŸ’ª

- æ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³ã«ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã•ã›ãªã„ã‚ˆã†ã« HTTP ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’è¨­å®š
- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã«ã‚ˆã‚‹ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ï¼ˆãƒ™ãƒ¼ã‚·ãƒƒã‚¯èªè¨¼ï¼‰

:::message
Next.js v13 ã®ç’°å¢ƒã‚’æƒ³å®šã—ã¦ã„ã¾ã™ã€‚
v13 ã¸ã® upgrade ã«ã¤ã„ã¦ã¯[å…¬å¼ Upgrade Guid](https://beta.nextjs.org/docs/upgrade-guide)ã‚’å‚ç…§ã—ã¦ã„ãŸã ã‘ã¾ã™ã¨å¹¸ã„ã§ã™ã€‚
:::

## å…·ä½“çš„ãªæ‰‹é †

### vercel ã®ãƒ‰ãƒ¡ã‚¤ãƒ³è¨­å®š

1. **Settings â†’ Domains ã‹ã‚‰åˆ©ç”¨ã—ãŸã„ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’è¿½åŠ ã™ã‚‹**

èµ¤æ ã®éƒ¨åˆ†ã«åˆ©ç”¨ã—ãŸã„ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’å…¥åŠ›ã—ã€`Add`ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã“ã¨ã§è¿½åŠ ã§ãã¾ã™ã€‚
ğŸ‘‡

![](https://storage.googleapis.com/zenn-user-upload/ba8067de871b-20230303.png)

2. **è¿½åŠ ã—ãŸãƒ‰ãƒ¡ã‚¤ãƒ³ã«å‰²ã‚Šå½“ã¦ã‚‹ Branch ã‚’å¤‰æ›´ã™ã‚‹**

å…ˆç¨‹è¿½åŠ ã—ãŸãƒ‰ãƒ¡ã‚¤ãƒ³ã®å³å´ã«ã‚ã‚‹`Edit`ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ã€ãƒ‰ãƒ¡ã‚¤ãƒ³è¨­å®šã‚’å¤‰æ›´ã§ãã¾ã™ã€‚
ğŸ‘‡

![](https://storage.googleapis.com/zenn-user-upload/1fc5faa736d8-20230303.png)

`Git Branch` ã«ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒã¨ã—ã¦è¨­å®šã—ãŸã„ `Branch` åã‚’å…¥åŠ›ã—ã¦ã€ä¿å­˜ã—ã¾ã™ã€‚
`develop`ãƒ–ãƒ©ãƒ³ãƒã‚’ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒã¨ã—ã¦è¨­å®šã—ãŸã„å ´åˆã¯ã€ç”»åƒã®ã‚ˆã†ã«`develop`ã¨å…¥åŠ›ã—ã¾ã™ã€‚
ğŸ‘‡

![](https://storage.googleapis.com/zenn-user-upload/b8b6fe8d07ad-20230303.png)

#### æœ¬ç•ªç’°å¢ƒ(Production)ã€ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒ(Preview)ã®ç’°å¢ƒå¤‰æ•°è¨­å®š

ç’°å¢ƒå¤‰æ•°ã‚’ä½¿ã£ã¦ã„ã‚‹ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å ´åˆã¯ã€ãã‚Œã‚‰ã‚’ vercel ã«è¨­å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
**Settings â†’ Environment Variables** ã§ç”»åƒã®èµ¤æ ã§ç¤ºã—ã¦ã„ã‚‹éƒ¨åˆ†ã«å…¥åŠ›ã™ã‚‹ã“ã¨ã§è¨­å®šã§ãã¾ã™ã€‚
ğŸ‘‡

![](https://storage.googleapis.com/zenn-user-upload/710d154ee08f-20230303.jpg)

`Environment` ã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã§ã€ç’°å¢ƒå¤‰æ•°ã‚’ã©ã®ç’°å¢ƒ(`Production` `Preview` `Development`)ã«è¨­å®šã™ã‚‹ã‹ã‚’æŒ‡å®šã§ãã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã£ã¦æœ¬ç•ªç’°å¢ƒ(`Production`)ã¨ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒ(`Preview`)ã§è¨­å®šã™ã‚‹ç’°å¢ƒå¤‰æ•°ã‚’å¤‰ãˆã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

ä»¥ä¸Šã§ã€vercel ã®ãƒ‰ãƒ¡ã‚¤ãƒ³è¨­å®šã¯å®Œäº†ã§ã™ ğŸ‘

### æ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³ã«ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã•ã‚Œãªã„ã‚ˆã†ã« HTTP ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’è¨­å®šã™ã‚‹

çµè«–ã‹ã‚‰è¨€ã†ã¨ã€æ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³ã«ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã•ã‚Œãªã„ã‚ˆã†ã«ã™ã‚‹ã«ã¯`next.config.js`ã«ä»¥ä¸‹ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚
ğŸ‘‡

```js:next.config.js
/** @type {import('next').NextConfig} */
const nextConfig = {
    ...
  async headers() {
    const headers = []
    if (process.env.NEXT_PUBLIC_VERCEL_ENV === 'preview') {
      headers.push({
        headers: [
          {
            key: 'X-Robots-Tag',
            value: 'noindex',
          },
        ],
        source: '/:path*',
      })
    }
    return headers
  },
}

module.exports = nextConfig

```

ğŸ‘€ **ã‚‚ã£ã¨è©³ã—ã**
vercel ã® Preview ç’°å¢ƒã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ HTTP ãƒ˜ãƒƒãƒ€ãƒ¼ã§ã‚ã‚‹`X-Robots-Tag`ãŒ`noindex`ã«è¨­å®šã•ã‚Œã¦ãŠã‚Šã€æ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³ã«ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã•ã‚Œãªã„ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚ã—ã‹ã—ã€Preview ç’°å¢ƒã«ç‹¬è‡ªãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹å ´åˆã¯ã€`X-Robots-Tag: noindex`ã¯è¨­å®šã•ã‚Œã¾ã›ã‚“ã€‚
è©¦ã—ã«ã€curl ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ Preview ç’°å¢ƒã«è¨­å®šã—ãŸãƒ‰ãƒ¡ã‚¤ãƒ³ã® HTTP ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ç¢ºèªã—ã¦ã¿ã‚‹ã¨`X-Robots-Tag`ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„ã“ã¨ãŒåˆ†ã‹ã‚Šã¾ã™ã€‚
ğŸ‘‡

```bash
$> curl -I https://[è¨­å®šã—ãŸãƒ‰ãƒ¡ã‚¤ãƒ³]
HTTP/2 200
accept-ranges: bytes
access-control-allow-origin: *
age: 2285775
cache-control: public, max-age=0, must-revalidate
content-disposition: inline
content-type: text/html; charset=utf-8
date: Fri, 03 Mar 2023 12:45:43 GMT
etag: "7b052e82f8dbd50afd0759998bad2456"
server: Vercel
strict-transport-security: max-age=63072000; includeSubDomains; preload
x-matched-path: /
x-vercel-cache: HIT
x-vercel-id: kix1:kix1::7tc9m-1677847543308-cb280fab7193
content-length: 11570
```

ã“ã‚Œã¯ã€[vercel å…¬å¼ã‚¬ã‚¤ãƒ‰](https://vercel.com/guides/are-vercel-preview-deployment-indexed-by-search-engines)ã«è¨˜è¼‰ã•ã‚Œã¦ã„ãŸã®ã§æ°—ã«ãªã‚‹æ–¹ã¯ãã¡ã‚‰ã‚‚ã”å‚ç…§ãã ã•ã„ã€‚

ãã®ãŸã‚ã€å…ˆç¨‹ã®å†…å®¹ã‚’`next.config.js`ã«è¿½åŠ ã™ã‚‹ã“ã¨ã§ã€ç‹¬è‡ªãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’è¨­å®šã—ãŸ Preview ç’°å¢ƒã«ã‚‚`X-Robots-Tag: noindex`ã‚’è¨­å®šã§ãã€æ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³ã«ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã•ã‚Œãªã„ã‚ˆã†ã«ã§ãã¾ã™ã€‚
è¿½åŠ å¾Œã«ã€curl ã‚³ãƒãƒ³ãƒ‰ã‚’ã‚‚ã†ä¸€åº¦å®Ÿè¡Œã—ã¦ã¿ã‚‹ã¨ã€`X-Robots-Tag: noindex`ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã—ãŸã€‚
ğŸ‘‡

```bash
curl -I https://[è¨­å®šã—ãŸãƒ‰ãƒ¡ã‚¤ãƒ³]
HTTP/2 200
accept-ranges: bytes
access-control-allow-origin: *
age: 0
cache-control: public, max-age=0, must-revalidate
content-disposition: inline
content-type: text/html; charset=utf-8
date: Fri, 03 Mar 2023 13:26:00 GMT
etag: "053a80bfd6f243d476e5c1d695e1f7ab"
server: Vercel
strict-transport-security: max-age=63072000; includeSubDomains; preload
x-matched-path: /
x-robots-tag: noindex ğŸ‘ˆğŸ˜†
x-vercel-cache: HIT
x-vercel-id: kix1:kix1::hsz75-1677849959681-b9a7e441fa89
content-length: 11570
```

### Next.js ã® Middleware ã‚’ä½¿ã£ã¦ãƒ™ãƒ¼ã‚·ãƒƒã‚¯èªè¨¼ã‚’å®Ÿè£…ã™ã‚‹

çµè«–ã‹ã‚‰è¨€ã†ã¨ã€ä»¥ä¸‹ã®æµã‚Œã§è¡Œãˆã°å®Ÿè£…ã§ãã¾ã™ã€‚

1. `pages` ãƒ•ã‚©ãƒ«ãƒ€ã¨åŒã˜éšå±¤ã«ã€ä»¥ä¸‹ã®`middleware.ts`ã‚’è¿½åŠ ã™ã‚‹

```js:src/middleware.ts
import type { NextRequest } from "next/server";
import { NextResponse } from "next/server";

export const config = {
  matcher: "/:path*",
};

export function middleware(req: NextRequest) {
  if (process.env.NEXT_PUBLIC_VERCEL_ENV === "preview") {
    const basicAuth = req.headers.get("authorization");
    const url = req.nextUrl;
    if (basicAuth) {
      const authValue = basicAuth.split(" ")[1];
      const [user, pwd] = atob(authValue).split(":");

      if (
        user === process.env.BASIC_USERNAME &&
        pwd === process.env.BASIC_PASSWORD
      ) {
        return NextResponse.next();
      }
    }
    url.pathname = "/api/auth";
    return NextResponse.rewrite(url);
  }
  return NextResponse.next();
}
```

2. `pages/api`ãƒ•ã‚©ãƒ«ãƒ€å†…ã«`auth.ts`ã‚’è¿½åŠ ã™ã‚‹

```js:src/pages/api/auth.ts
import type { NextApiRequest, NextApiResponse } from "next";

export default function handler(_: NextApiRequest, res: NextApiResponse) {
  res.setHeader("WWW-authenticate", 'Basic realm="Secure Area"');
  res.statusCode = 401;
  res.end(`Auth Required.`);
}
```

3. ç’°å¢ƒå¤‰æ•°ã‚’è¿½åŠ ã™ã‚‹

```js:.env.local
BASIC_USERNAME='ä»»æ„ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼å'
BASIC_PASSWORD='ä»»æ„ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰'
```

ğŸ‘€ **ã‚‚ã£ã¨è©³ã—ã**
å…¬å¼ãŒãƒ™ãƒ¼ã‚·ãƒƒã‚¯èªè¨¼ã®å®Ÿè£…ä¾‹([Basic Auth Password Protection](https://github.com/vercel/examples/tree/main/edge-middleware/basic-auth-password))ã‚’å…¬é–‹ã—ã¦ã„ã‚‹ã®ã§ã€ã“ã‚Œã‚’å‚è€ƒã« Preview ç’°å¢ƒã®ã¿ã«ãƒ™ãƒ¼ã‚·ãƒƒã‚¯èªè¨¼ã‚’è¡Œã†ã‚ˆã†ã«å®Ÿè£…ã—ã¾ã—ãŸã€‚
ã¾ãšã€å®Ÿè£…ä¾‹ã‚’è¦‹ã‚‹ã¨ä»¥ä¸‹ã® 2 ã¤ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ã£ã¦ãƒ™ãƒ¼ã‚·ãƒƒã‚¯èªè¨¼ã‚’å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚

```js:middleware.ts
import { NextRequest, NextResponse } from 'next/server'

export const config = {
  matcher: ['/', '/index'],
}

export function middleware(req: NextRequest) {
  const basicAuth = req.headers.get('authorization')
  const url = req.nextUrl

  if (basicAuth) {
    const authValue = basicAuth.split(' ')[1]
    const [user, pwd] = atob(authValue).split(':')

    if (user === '4dmin' && pwd === 'testpwd123') {
      return NextResponse.next()
    }
  }
  url.pathname = '/api/auth'

  return NextResponse.rewrite(url)
}
```

```js:pages/api/auth.ts
import type { NextApiRequest, NextApiResponse } from 'next'

export default function handler(_: NextApiRequest, res: NextApiResponse) {
  res.setHeader('WWW-authenticate', 'Basic realm="Secure Area"')
  res.statusCode = 401
  res.end(`Auth Required.`)
}
```

`auth.ts`ã¯å¤‰æ›´ã›ãšã«ãã®ã¾ã¾ä½¿ã£ã¦ãŠã‚Šã€`middleware.ts`ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«å¤‰æ›´ã‚’åŠ ãˆã¾ã—ãŸã€‚
ğŸ‘‡

```diff js:src/middleware.ts
- import { NextRequest, NextResponse } from 'next/server'
+ import type {NextRequest} from 'next/server'
+ import {NextResponse} from 'next/server'

export const config = {
-  matcher: ['/', '/index'],
+  matcher: "/:path*",
}

export function middleware(req: NextRequest) {
+  if (process.env.NEXT_PUBLIC_VERCEL_ENV === "preview") {
    const basicAuth = req.headers.get("authorization");
    const url = req.nextUrl;
    if (basicAuth) {
      const authValue = basicAuth.split(" ")[1];
      const [user, pwd] = atob(authValue).split(":");

-      if (user === '4dmin' && pwd === 'testpwd123') {
+      if (
+        user === process.env.BASIC_USERNAME &&
+        pwd === process.env.BASIC_PASSWORD
+      ) {
        return NextResponse.next();
      }
    }
    url.pathname = "/api/auth";
    return NextResponse.rewrite(url);
  }
+  return NextResponse.next();
}
```

å¤‰æ›´ã‚’åŠ ãˆãŸå†…å®¹ã¯ã€ä»¥ä¸‹ã® 3 ç‚¹ã«ãªã‚Šã¾ã™ã€‚

1. `matcher`ã§å…¨ã¦ã®ãƒ‘ã‚¹ã‚’å¯¾è±¡ã«ã™ã‚‹ã‚ˆã†ã«æŒ‡å®š
2. ãƒ™ãƒ¼ã‚·ãƒƒã‚¯èªè¨¼ã‚’ vercel ã® Preview ç’°å¢ƒã®ã¿è¡Œã†
3. `user`ã€`password`ã¯ç’°å¢ƒå¤‰æ•°ã¨ã—ã¦å¤–éƒ¨ã‹ã‚‰è¦‹ãˆãªã„ã‚ˆã†ã«ã™ã‚‹

#### vercel ã¸ã®ç’°å¢ƒå¤‰æ•°ã®è¿½åŠ ã‚‚å¿˜ã‚Œãªã„ã‚ˆã†ã«ï¼ï¼ï¼

ãƒ™ãƒ¼ã‚·ãƒƒã‚¯èªè¨¼ã®ãŸã‚ã«ç’°å¢ƒå¤‰æ•°ã‚’è¿½åŠ ã—ãŸã®ã§ã€vercel ã«ã‚‚è¨­å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
ğŸ‘‡
![](https://storage.googleapis.com/zenn-user-upload/5f8b18ca154d-20230304.jpg)

Preview ç’°å¢ƒã®ã¿ãƒ™ãƒ¼ã‚·ãƒƒã‚¯èªè¨¼ã‚’è¡Œã†ã‚ˆã†ã«ã—ã¦ã„ã‚‹ãŸã‚ã€`Environment`ã«ã¯ Preview ã®ã¿ã«ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã¾ã™ã€‚

## å®Ÿè£…å®Œäº†

ä»¥ä¸Šã§ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§æ±‚ã‚ã‚‰ã‚Œã‚‹ã“ã¨ãŒå¤šã„ SEO ã‚„ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®å•é¡Œã‚’è€ƒæ…®ã—ãŸã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒæ§‹ç¯‰ãŒå®Œäº†ã§ã™ ğŸ‰

ãŠç–²ã‚Œã•ã¾ã§ã—ãŸï¼ï¼
