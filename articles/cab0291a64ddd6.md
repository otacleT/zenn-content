---
title: "Next.jsÃ—Firestoreã§é‡è¤‡æ¤œçŸ¥ã‚’æŒã£ãŸäº‹å‰ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ ã‚’ä½œã£ã¦ã¿ãŸ"
emoji: "ğŸ™"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["firestore", "nextjs", "typescript", "reacthookform", "zod"]
published: true
---

## ã“ã®è¨˜äº‹ã«ã¤ã„ã¦

ã‚¢ãƒ«ãƒã‚¤ãƒˆå…ˆã§ NFT ãƒãƒ¼ã‚±ãƒƒãƒˆãƒ—ãƒ¬ã‚¤ã‚¹ã®äº‹å‰ç™»éŒ²ã‚µã‚¤ãƒˆã‚’ 1 ã‹ã‚‰å…¨ã¦æ‹…å½“ã•ã›ã¦ã„ãŸã ãæ©Ÿä¼šãŒã‚ã‚Šã€ãã®ã¨ãã«å¾—ãŸçŸ¥è¦‹ã‚’ã“ã®å ´ã‚’å€Ÿã‚Šã¦å…±æœ‰ã—ãŸã„ã¨æ€ã„ã¾ã™ ğŸ‘

ã“ã®è¨˜äº‹ã¯ã€[Cloud Firestore](https://firebase.google.com/docs/firestore?hl=ja)ã¨ Next.js ã‚’ä½¿ã£ã¦ã€äº‹å‰ç™»éŒ²ã‚µã‚¤ãƒˆã®ã‚ˆã†ã«é‡è¤‡æ¤œçŸ¥ãŒå¿…è¦ãªãƒ•ã‚©ãƒ¼ãƒ ã®ä½œæˆæ–¹æ³•ã«ã¤ã„ã¦ã¾ã¨ã‚ãŸã‚‚ã®ã§ã™ã€‚
ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆã«ã¯ã€[react-hook-form](https://react-hook-form.com/)ã¨[zod](https://github.com/colinhacks/zod)ã‚’ä½¿ã£ã¦ã„ã¾ã™ã€‚

æœ¬è¨˜äº‹å†…ã§ã¯ç°¡ç•¥åŒ–ã®ãŸã‚ã«å„è¦ç´ ã® style ã‚„ã€éåŒæœŸå‡¦ç†ã®ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°å‡¦ç†ã‚’å®Ÿè£…ã—ã¦ã„ã¾ã›ã‚“ã€‚ã‚‚ã—æ°—ã«ãªã‚‹æ–¹ã¯ãã‚Œã‚‰ã‚’å«ã‚ãŸå®Ÿè£…ä¾‹ã‚’å…¬é–‹ã—ã¦ã„ã‚‹ã®ã§ã€ã”å‚ç…§ã„ãŸã ã‘ã¾ã™ã¨å¹¸ã„ã§ã™ã€‚
[![otacleT/nextjs-firestore-formApp - GitHub](https://gh-card.dev/repos/otacleT/nextjs-firestore-formApp.svg)](https://github.com/otacleT/nextjs-firestore-formApp)

ãã‚Œã§ã¯è¦‹ã¦ã„ãã¾ã—ã‚‡ã† ğŸ‰

## ç’°å¢ƒæ§‹ç¯‰

ã¯ã˜ã‚ã«ã€[Create Next App](https://nextjs.org/docs/api-reference/create-next-app)ã‚’ä½¿ã£ã¦ Next.js ã®ç’°å¢ƒæ§‹ç¯‰ã‚’è¡Œã„ã¾ã™ã€‚`--typescript`ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ã¤ã‘ã‚‹ã“ã¨ã§ã€TypeScript ãŒå«ã¾ã‚ŒãŸçŠ¶æ…‹ã§ Next.js ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ§‹ç¯‰ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```bash:Next.jsã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ§‹ç¯‰
$> yarn create next-app --typescript
```

æ¬¡ã«ã€ä½œæˆã•ã‚ŒãŸãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã§ä»Šå›ä½¿ç”¨ã™ã‚‹ package ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚’è¡Œã„ã¾ã™ã€‚

```bash:ä½¿ç”¨ã™ã‚‹packageã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
$> yarn add react-hook-form @hookform/resolvers zod
```

ã“ã“ã§ç°¡å˜ã«ã§ã™ãŒã€ä»¥ä¸‹ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãŸ package ã®èª¬æ˜ã‚’æ›¸ã„ã¦ãŠãã¾ã™ã€‚

- react-hook-formï¼š
  React å‘ã‘ã®ãƒ•ã‚©ãƒ¼ãƒ ç®¡ç†ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
- @hookform/resolversï¼š
  `Yup`ã€`Zod`ç­‰ã‚’ä½¿ç”¨ã—ãŸã‚¹ã‚­ãƒ¼ãƒãƒ™ãƒ¼ã‚¹ã®ãƒ•ã‚©ãƒ¼ãƒ æ¤œè¨¼ã‚’å¯èƒ½ã«ã™ã‚‹ã‚‚ã®ã€‚`useForm`ã«ã‚¹ã‚­ãƒ¼ãƒã‚’æ¸¡ã™éš›ã«ä½¿ã†ã€‚ï¼ˆ[å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://react-hook-form.com/get-started#SchemaValidation)ï¼‰
- zodï¼š
  TypeScript first ãªãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã€‚ã‚¹ã‚­ãƒ¼ãƒãƒ™ãƒ¼ã‚¹ã®ãƒ•ã‚©ãƒ¼ãƒ æ¤œè¨¼ã®éš›ã«ä½¿ã†ã€‚
  Zod ã®ä½¿ã„æ–¹ã«ã¤ã„ã¦ã¯ä»¥ä¸‹ã®è¨˜äº‹ãŒã¨ã¦ã‚‚åˆ†ã‹ã‚Šã‚„ã™ã‹ã£ãŸã§ã™ ğŸ‘‡

https://zenn.dev/uttk/articles/bd264fa884e026

### ğŸ¤” ãªãœ React Hook Form ã«ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’çµ„ã¿åˆã‚ã›ã‚‹ã®ã‹

React Hook Form ã®å…¬å¼ã§ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«æ²ã’ã‚‰ã‚Œã¦ãŠã‚Šã€React Hook Form ã§ã‚‚ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè£…ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

> é«˜æ€§èƒ½ã§æŸ”è»Ÿã‹ã¤æ‹¡å¼µå¯èƒ½ãªä½¿ã„ã‚„ã™ã„ãƒ•ã‚©ãƒ¼ãƒ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ©ã‚¤ãƒ–ãƒ©ãƒª

ã—ã‹ã—ã€React Hook Form ã§è¤‡é›‘ãªãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿç¾ã—ã‚ˆã†ã¨ã™ã‚‹ã¨ã€ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‹ã‚‰ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚¸ãƒƒã‚¯ã‚’åˆ‡ã‚Šå‡ºã™ã“ã¨ãŒé›£ã—ãä»¥ä¸‹ã®å•é¡ŒãŒç”Ÿã˜ã¾ã™ã€‚

- ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã®ç®¡ç†ãƒ»æŠŠæ¡ãŒé›£ã—ã„
- ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚¸ãƒƒã‚¯ã®ä½¿ã„å›ã—ãŒã§ããªã„
- ãƒ†ã‚¹ãƒˆã‚’æ›¸ãã“ã¨ãŒé›£ã—ã„

ãã®ãŸã‚ã€`Zod`ã‚„`Yup`ãªã©ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ã£ã¦ã‚¹ã‚­ãƒ¼ãƒãƒ™ãƒ¼ã‚¹ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¡Œã†ã“ã¨ã§ã€ã“ã‚Œã‚‰ã®å•é¡Œã‚’è§£æ±ºã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ âœ¨

### Firebase ç’°å¢ƒæ§‹ç¯‰

:::message
Firebase ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­å®šã«ã¤ã„ã¦ã¯ã€æœ¬è¨˜äº‹å†…ã§ã¯æ‰±ã„ã¾ã›ã‚“ã€‚
ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­å®šã«ã¤ã„ã¦ã¯ã€ä»¥ä¸‹ã®å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‚ç…§ã—ã¦ã„ãŸã ã‘ã¾ã™ã¨å¹¸ã„ã§ã™ã€‚

- [Cloud Firestore ã‚’ä½¿ã£ã¦ã¿ã‚‹](https://firebase.google.com/docs/firestore/quickstart?hl=ja)
  :::
  Cloud Firestore ã®åˆ©ç”¨ã«å¿…è¦ãª Firebase SDK ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚’è¡Œã„ã¾ã™ã€‚

```bash:Firebase SDKã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
$> yarn add firebase
```

æ¬¡ã«ã€Firebase ã‚’åˆæœŸåŒ–ã—ã€Cloud Firestore ã®åˆ©ç”¨ã‚’é–‹å§‹ã™ã‚‹ãŸã‚ã®å‡¦ç†ã‚’è¿½åŠ ã—ã¾ã™ã€‚

```js:src/lib/firebase/init.ts
import {getApps, initializeApp} from 'firebase/app'
import {getFirestore} from 'firebase/firestore'

/**
 * @note ç®¡ç†ç”»é¢ã‹ã‚‰å–å¾—ã—ãŸFirebaseã®APIã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’`.env.local`ã«è¨˜è¿°ã—ã¦ã„ã¾ã™
 */
const firebaseConfig = {
  apiKey: process.env.NEXT_PUBLIC_FIREBASE_API_KEY,
  appId: process.env.NEXT_PUBLIC_FIREBASE_APP_ID,
  authDomain: process.env.NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN,
  measurementId: process.env.NEXT_PUBLIC_FIREBASE_MEASUREMENT_ID,
  messagingSenderId: process.env.NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID,
  projectId: process.env.NEXT_PUBLIC_FIREBASE_PROJECT_ID,
  storageBucket: process.env.NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET,
}

/**
 * @description Firebase instanceã®åˆæœŸåŒ–
 */
if (!getApps()?.length) {
  initializeApp(firebaseConfig)
}

/**
 * @description Firestoreã‚’è¿”ã™
 */
export const db = getFirestore()
```

ã“ã‚Œã§ç’°å¢ƒæ§‹ç¯‰ã¯å…¨ã¦å®Œäº†ã§ã™ ğŸ‘

## react-hook-form ã¨ zod ã§äº‹å‰ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ å®Ÿè£…

ä»Šå›ä½œæˆã™ã‚‹äº‹å‰ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ ã§ã¯ã€å…¥åŠ›å€¤ã¨ã—ã¦ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ã‚¦ã‚©ãƒ¬ãƒƒãƒˆã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æƒ³å®šã—ã¦ã„ã‚‹ãŸã‚ä»¥ä¸‹ã®ã‚ˆã†ã«å‹ã‚’å®šç¾©ã—ã¾ã™ã€‚

```js:src/type/UserInfo.ts
export type UserInfo = {
  email: string
  walletAddress: string
}
```

ã¾ãŸã€ãã‚Œãã‚ŒãŒæº€ãŸã™ã¹ãæ¡ä»¶ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚

### å„å…¥åŠ›å€¤ã®æ¡ä»¶

- ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
  - å¿…é ˆé …ç›®ã§ã‚ã‚‹
  - æ­£ã—ã„ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã§ã‚ã‚‹
- ã‚¦ã‚©ãƒ¬ãƒƒãƒˆã‚¢ãƒ‰ãƒ¬ã‚¹
  - å¿…é ˆé …ç›®ã§ã‚ã‚‹
  - `0x`ã‹ã‚‰å§‹ã¾ã‚‹æ–‡å­—åˆ—ã§ã‚ã‚‹
  - 42 æ–‡å­—ã®æ–‡å­—åˆ—ã§ã‚ã‚‹

ã“ã®ã“ã¨ã‚’è¸ã¾ãˆã¦ã€ä»¥ä¸‹ã®ã‚ˆã†ãªãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å«ã‚“ã ãƒ•ã‚©ãƒ¼ãƒ ã‚’ä½œæˆã—ã¾ã—ãŸã€‚
ç¾æ™‚ç‚¹ã§ã¯å…¥åŠ›ã•ã‚ŒãŸå€¤ã‚’ console ã«è¡¨ç¤ºã•ã›ã‚‹å‡¦ç†ã«ãªã£ã¦ã„ã‚‹ã®ã§ã€ãƒ­ã‚¸ãƒƒã‚¯éƒ¨åˆ†ãŒå®Œæˆã—ãŸå¾Œã«æ›´æ–°ã—ã¦ã„ãã¾ã™ ğŸ‘
:::message
ç°¡ç•¥åŒ–ã®ãŸã‚ã«ãƒ‡ã‚¶ã‚¤ãƒ³éƒ¨åˆ†ã‚’é™¤ã„ãŸå®Ÿè£…ã«ãªã£ã¦ã„ã¾ã™ã€‚
style ç­‰ã¯å„è‡ªã§æŒ‡å®šã—ã¦ã„ãŸã ã‘ã¾ã™ã¨å¹¸ã„ã§ã™ã€‚
:::

```js:src/pages/index.tsx
import {zodResolver} from '@hookform/resolvers/zod'
import type {NextPage} from 'next'
import {useCallback} from 'react'
import {useForm} from 'react-hook-form'
import {z} from 'zod'

import type {UserInfo} from '@/type/UserInfo'

const regex = /^0x/

const schema = z.object({
  email: z
    .string()
    .min(1, {message: 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'})
    .email('ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚'),
  walletAddress: z
    .string()
    .min(1, {message: 'ã‚¦ã‚©ãƒ¬ãƒƒãƒˆã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'})
    .regex(regex, {
      message: 'ã‚¦ã‚©ãƒ¬ãƒƒãƒˆã‚¢ãƒ‰ãƒ¬ã‚¹ã¯0xã‹ã‚‰å§‹ã¾ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚',
    })
    .length(42, {
      message: 'ã‚¦ã‚©ãƒ¬ãƒƒãƒˆã‚¢ãƒ‰ãƒ¬ã‚¹ã¯42æ–‡å­—ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚',
    }),
})

const Home: NextPage = () => {
  const {
    formState: {errors},
    handleSubmit,
    register,
  } = useForm<UserInfo>({
    resolver: zodResolver(schema),
  })
  const onSubmit = useCallback((data: UserInfo) => {
    console.info(data)
  }, [])
  return (
    <main>
      <form onSubmit={handleSubmit(onSubmit)}>
        <input placeholder='ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ã”å…¥åŠ›ãã ã•ã„' type='email' {...register('email')} />
        <p>{errors.email?.message}</p>
        <input
          placeholder='ã‚¦ã‚©ãƒ¬ãƒƒãƒˆã‚¢ãƒ‰ãƒ¬ã‚¹(0x..)ã‚’ã”å…¥åŠ›ãã ã•ã„'
          type='text'
          {...register('walletAddress')}
        />
        <p>{errors.walletAddress?.message}</p>
        <button type='submit'>ç™»éŒ²ã™ã‚‹</button>
      </form>
    </main>
  )
}

export default Home
```

[React Hook Form å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://react-hook-form.com/get-started#SchemaValidation)ã¨ã»ã¨ã‚“ã©å¤‰ã‚ã‚‰ãªã„å®Ÿè£…ãªã®ã§ã™ãŒã€React Hook Form ã«ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ç”¨ã—ãŸãƒ•ã‚©ãƒ¼ãƒ ä½œæˆã®æµã‚Œã‚’ç°¡å˜ã«èª¬æ˜ã™ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

1. ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ç”¨ã—ã¦ schema ã‚’ä½œæˆã™ã‚‹
2. å…ˆç¨‹ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãŸ`@hookform/resolvers`ã‚’ç”¨ã„ã¦`useForm`ã« schema ã‚’æ¸¡ã™

## Firestore ã«ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ ã™ã‚‹å‡¦ç†ã‚’å®Ÿè£…

ã“ã“ã‹ã‚‰ãƒ­ã‚¸ãƒƒã‚¯éƒ¨åˆ†ã®å®Ÿè£…ã‚’è¡Œã£ã¦ã„ãã¾ã™ã€‚
ã¾ãšã€Firestore ã¸ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ ã™ã‚‹å‡¦ç†ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```js:src/hook/useRegister.ts
import {addDoc, collection} from 'firebase/firestore'
import {useCallback} from 'react'

import {db} from '@/lib/firebase/init'
import type {UserInfo} from '@/type/UserInfo'

export const useRegister = () => {
  const registerUser = useCallback(async (info: UserInfo) => {
    await addDoc(collection(db, `users/`), {
      email: info.email,
      walletAddress: info.walletAddress,
    }).catch((error) => {
      throw new Error(error)
    })
  }, [])

  return {registerUser}
}
```

### ğŸ’¡ Firestore ã¸ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ ã™ã‚‹ 2 ã¤ã®æ–¹æ³•

- setDoc()ï¼šä½œæˆã™ã‚‹ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã® ID ã‚’æŒ‡å®šã™ã‚‹æ–¹æ³•

```js
await setDoc(doc(db, "users", "new-user-id"), data);
```

- addDoc()ï¼šFirestore ãŒ ID ã‚’è‡ªå‹•çš„ã«ç”Ÿæˆã—ã¦ãã‚Œã‚‹æ–¹æ³•

```js
await addDoc(collection(db, "cities"), data);
```

ä»Šå›ä½œæˆã—ãŸç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ ã§ã¯ã€è‡ªå‹•çš„ã« ID ã‚’ç”Ÿæˆã™ã‚‹æ–¹æ³•ãŒé©ã—ã¦ã„ãŸãŸã‚`addDoc()`ã‚’ä½¿ã£ãŸæ–¹æ³•ã§å®Ÿè£…ã—ã¾ã—ãŸã€‚Firestore ã¸ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ ã™ã‚‹æ–¹æ³•ã®è©³ç´°ã«ã¤ã„ã¦ã¯ã€[Firebase å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://cloud.google.com/firestore/docs/manage-data/add-data?hl=ja#add_a_document)ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

## Firestore ã«æ—¢ã«ç™»éŒ²æ¸ˆã¿ã®å€¤ã‚’æ¤œçŸ¥ã™ã‚‹å‡¦ç†ã‚’å®Ÿè£…

æ¬¡ã«ã€Firestore ã«æ—¢ã«ç™»éŒ²æ¸ˆã¿ã®å€¤ã‚’æ¤œçŸ¥ã™ã‚‹å‡¦ç†ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```js:src/hook/useCheckRegistered.ts
import {collection, getDocs, query, where} from 'firebase/firestore'
import {useCallback} from 'react'

import {db} from '@/lib/firebase/init'
import type {UserInfo} from '@/type/UserInfo'

export const useCheckRegistered = () => {
  const checkRegistered = useCallback(async ({email, walletAddress}: UserInfo) => {
    // usersã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã¸ã®referenceã‚’ä½œæˆ
    const usersRef = collection(db, 'users')

    // usersã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã«å¯¾ã™ã‚‹ã‚¯ã‚¨ãƒªã‚’ä½œæˆ
    const qEmail = query(usersRef, where('email', '==', email))
    const qWalletAddress = query(usersRef, where('walletAddress', '==', walletAddress))

    // ã‚¯ã‚¨ãƒªã‚’å®Ÿè¡Œã—ã€çµæœã‚’å–å¾—
    const isEmail = await getDocs(qEmail)
    const isWalletAddress = await getDocs(qWalletAddress)

    // isEmail, isWalletAddressãŒç©ºã§ã‚ã‚‹ã‹ã©ã†ã‹ã§ã€ç™»éŒ²æ¸ˆã¿ã‹ã©ã†ã‹ã‚’åˆ¤å®š
    return {email: !!isEmail.docs.length, walletAddress: !!isWalletAddress.docs.length}
  }, [])

  return {checkRegistered}
}
```

Firestore ã§ã¯ã€ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã¾ãŸã¯ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚°ãƒ«ãƒ¼ãƒ—ã‹ã‚‰å–å¾—ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ã‚¨ãƒªã«ã‚ˆã£ã¦æŒ‡å®šã™ã‚‹ã“ã¨ãŒã§ãã‚‹ãŸã‚ã€æ—¢ã«ç™»éŒ²æ¸ˆã¿ã®å€¤ã§ã‚ã‚‹ã‹ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªæµã‚Œã§å®Ÿè£…ã‚’è¡Œã„ã¾ã—ãŸã€‚

1. users ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã¸ã® reference ã‚’ä½œæˆ
2. users ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã«å¯¾ã™ã‚‹`email`ã¨`walletAddress`ã®ã‚¯ã‚¨ãƒªã‚’ä½œæˆ
3. `getDocs()`ã‚’å®Ÿè¡Œã—ã¦ã€ä½œæˆã—ãŸã‚¯ã‚¨ãƒªã«å¯¾ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
4. å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿ãŒç©ºã§ã‚ã‚‹ã‹ã©ã†ã‹ã§ã€æ—¢ã« Firestore ã¸ç™»éŒ²æ¸ˆã¿ã®å€¤ã§ã‚ã‚‹ã‹ã©ã†ã‹ã‚’åˆ¤å®š

Firestore ã«ãŠã‘ã‚‹ãƒ‡ãƒ¼ã‚¿ã®ã‚¯ã‚¨ãƒªã«ã¤ã„ã¦è©³ã—ãçŸ¥ã‚ŠãŸã„æ–¹ã¯ã€å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‚ç…§ã—ã¦ã„ãŸã ã‘ã¾ã™ã¨å¹¸ã„ã§ã™ã€‚ğŸ‘‡
https://cloud.google.com/firestore/docs/query-data/queries?hl=ja

## äº‹å‰ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ ã‚’å®Œæˆã•ã›ã‚‹

ãƒ­ã‚¸ãƒƒã‚¯éƒ¨åˆ†ãŒå®Œæˆã—ãŸã®ã§ã€react-hook-form ã¨ zod ã§ä½œæˆã—ãŸãƒ•ã‚©ãƒ¼ãƒ ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«æ›´æ–°ã—ã¾ã™ã€‚

```diff js:src/pages/index.tsx
...
+  const onSubmit = useCallback(
+    async (data: UserInfo) => {
+      // å…¥åŠ›ã•ã‚ŒãŸå€¤ãŒæ—¢ã«ç™»éŒ²æ¸ˆã¿ã‹ã©ã†ã‹ã‚’åˆ¤å®šã™ã‚‹
+      const isRegistered = await checkRegistered(data).catch(() => {
+        alert('å•é¡ŒãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚æ™‚é–“ã‚’ãŠã„ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚')
+      })
+
+      if (isRegistered?.email && isRegistered?.walletAddress) {
+        // ä¸¡æ–¹ç™»éŒ²æ¸ˆã¿ã®å ´åˆ
+        alert('ã“ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ã‚¦ã‚©ãƒ¬ãƒƒãƒˆã‚¢ãƒ‰ãƒ¬ã‚¹ã¯æ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™ã€‚')
+      } else if (isRegistered?.email) {
+        // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®ã¿ç™»éŒ²æ¸ˆã¿ã®å ´åˆ
+        alert('ã“ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯æ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™ã€‚')
+      } else if (isRegistered?.walletAddress) {
+        // ã‚¦ã‚©ãƒ¬ãƒƒãƒˆã‚¢ãƒ‰ãƒ¬ã‚¹ã®ã¿ç™»éŒ²æ¸ˆã¿ã®å ´åˆ
+        alert('ã“ã®ã‚¦ã‚©ãƒ¬ãƒƒãƒˆã‚¢ãƒ‰ãƒ¬ã‚¹ã¯æ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™ã€‚')
+      } else {
+        // ã©ã¡ã‚‰ã‚‚æœªç™»éŒ²ã®å ´åˆ
+        await registerUser(data)
+          .then(() => {
+            console.info('ç™»éŒ²å®Œäº†')
+          })
+          .catch(() => {
+            alert('å•é¡ŒãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚æ™‚é–“ã‚’ãŠã„ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚')
+          })
+      }
+    },
+    [registerUser, checkRegistered]
+  )
-  const onSubmit = useCallback((data: UserInfo) => {
-    console.info(data)
-  }, [])
...
```

## å®Ÿè£…å®Œäº† âœ¨

ä»¥ä¸Šã§é‡è¤‡æ¤œçŸ¥ã‚’æŒã£ãŸäº‹å‰ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ ãŒå®Œæˆã§ã™...ï¼

ãƒ•ã‚©ãƒ¼ãƒ ã«å…¥åŠ›ã•ã‚ŒãŸå€¤ãŒæœªç™»éŒ²ã®å ´åˆã¯ Firebase ã¸ãƒ‡ãƒ¼ã‚¿ãŒè¿½åŠ ã•ã‚Œã€ãã†ã§ãªã„å ´åˆã¯ã¯ã˜ã‹ã‚Œã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹ã¨æ€ã„ã¾ã™ ğŸ™Œ

ãŠç–²ã‚Œã•ã¾ã§ã—ãŸï¼ï¼ï¼
